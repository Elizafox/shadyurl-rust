/* SPDX-License-Identifier: CC0-1.0
 *
 * src/generate.rs
 *
 * This file is a component of ShadyURL by Elizabeth Myers.
 *
 * To the extent possible under law, the person who associated CC0 with
 * ShadyURL has waived all copyright and related or neighboring rights
 * to ShadyURL.
 *
 * You should have received a copy of the CC0 legalcode along with this
 * work.  If not, see <http://creativecommons.org/publicdomain/zero/1.0/>.
 */

use once_cell::sync::Lazy;
use rand::{
    distributions::{DistString, Distribution, Uniform},
    prelude::*,
    seq::SliceRandom,
    Rng,
};
use rand_distr::Alphanumeric;

use crate::util::macros::arr;

#[derive(PartialEq, Eq, Copy, Clone)]
enum Mangler {
    NoOp,
    RandomUppercase,
    AllUppercase,
    ReplaceSeps,
    NumberLookalike,
}

fn generate_hash(rng: &mut dyn RngCore) -> String {
    let distr_count = Lazy::new(|| Uniform::new_inclusive(5, 9));
    let count = distr_count.sample(rng);
    Alphanumeric.sample_string(rng, count)
}

fn perform_mangle(fragment: &str, mangler: Mangler, rng: &mut dyn RngCore) -> String {
    match mangler {
        Mangler::RandomUppercase => fragment
            .chars()
            .map(|ch| {
                let distr_cap = Lazy::new(|| Uniform::new(0, 3));
                if (*distr_cap).sample(rng) == 0 {
                    ch.to_uppercase().collect()
                } else {
                    ch.to_string()
                }
            })
            .collect(),
        Mangler::AllUppercase => fragment.to_uppercase(),
        Mangler::ReplaceSeps => fragment
            .chars()
            .map(|ch| {
                let distr_replace = Lazy::new(|| Uniform::new(0, 4));
                if ch == '-' && (*distr_replace).sample(rng) == 0 {
                    arr!(const SEPS: [&str; _] = ["!", "_", "+", "$"]);
                    SEPS.choose(rng).unwrap().to_string()
                } else {
                    ch.to_string()
                }
            })
            .collect(),
        Mangler::NumberLookalike => fragment
            .chars()
            .map(|ch| {
                let distr_replace = Lazy::new(|| Uniform::new(0, 4));
                if (*distr_replace).sample(rng) == 0 {
                    match ch {
                        'o' | 'O' => '0',
                        'a' | 'A' => '4',
                        'e' | 'E' => '3',
                        'g' | 'G' => '9',
                        'i' | 'I' | 'l' | 'L' => '1',
                        's' | 'S' => '5',
                        't' | 'T' => '7',
                        _ => ch,
                    }
                } else {
                    ch
                }
            })
            .collect(),
        Mangler::NoOp => fragment.to_string(),
    }
}

fn get_mangler(rng: &mut dyn RngCore) -> Mangler {
    let distr_mangle = Lazy::new(|| Uniform::new(0, 12));
    match (*distr_mangle).sample(rng) {
        // 1/3 probability of selecting a mangler
        0 => Mangler::AllUppercase,
        1 => Mangler::RandomUppercase,
        2 => Mangler::ReplaceSeps,
        3 => Mangler::NumberLookalike,
        _ => Mangler::NoOp,
    }
}

fn mangle_fragment(fragment: &str, rng: &mut dyn RngCore) -> String {
    // Select mangling function
    let distr_second_mangler = Lazy::new(|| Uniform::new(0, 4));
    let mangler = get_mangler(rng);
    let new = perform_mangle(fragment, mangler, rng);

    if (*distr_second_mangler).sample(rng) == 0 {
        // 1/4 chance to apply a second mangler
        let mangler = match mangler {
            Mangler::AllUppercase | Mangler::RandomUppercase => {
                // Don't repeat a case mangling
                if rng.gen() {
                    Mangler::ReplaceSeps
                } else {
                    Mangler::NumberLookalike
                }
            }
            Mangler::ReplaceSeps => match rng.gen_range(0..=2) {
                0 => Mangler::AllUppercase,
                1 => Mangler::RandomUppercase,
                2 => Mangler::NumberLookalike,
                _ => Mangler::NoOp,
            },
            Mangler::NumberLookalike => match rng.gen_range(0..=2) {
                0 => Mangler::AllUppercase,
                1 => Mangler::RandomUppercase,
                2 => Mangler::ReplaceSeps,
                _ => Mangler::NoOp,
            },
            Mangler::NoOp => Mangler::NoOp,
        };

        return perform_mangle(&new, mangler, rng);
    }

    new
}

pub(crate) fn shady_filename(rng: &mut dyn RngCore) -> String {
    arr!(const SEPS: [&str; _] = ["!", "_", "+", "~"]);

    // These never change, so no point in regenerating them each time
    let distr_count = Lazy::new(|| Uniform::new_inclusive(4, 6));

    /* We multiply by 2 so we can put on the separators and suffix, which will be at odd positions.
     * The total number of separators plus the suffix works out to be double the nsfw_count.
     * This means the hash_pos must be doubled, too, to be in the right spot.
     */
    let nsfw_count_orig = distr_count.sample(rng);
    let nsfw_count = nsfw_count_orig * 2;
    let hash_pos = rng.gen_range(1..(nsfw_count_orig - 2)) * 2;
    let fake_extension_pos = if rng.gen() {
        loop {
            let n = rng.gen_range(1..(nsfw_count_orig - 2)) * 2;
            if n != hash_pos {
                break n;
            }
        }
    } else {
        // Deliberately out of range, so it won't be generated.
        (nsfw_count_orig + 1) * 2
    };

    (0..nsfw_count)
        .map(|i| {
            if (i & 1) == 1 {
                // This is odd. Do we tack on the suffix or a separator?
                if i == nsfw_count - 1 {
                    EXT_EXE.choose(rng).unwrap().to_string()
                } else if (i + 1) != fake_extension_pos {
                    // We want to skip this if the next one is the extension.
                    // This position will always be odd, since nsfw_count * 2 is always even.
                    // NB: the range is [0..nsfw_count * 2)
                    SEPS.choose(rng).unwrap().to_string()
                } else {
                    // Insert empty string, "this space intentionally left blank."
                    String::new()
                }
            } else if i == hash_pos {
                generate_hash(rng)
            } else if i == fake_extension_pos {
                EXT.choose(rng).unwrap().to_string()
            } else {
                let nsfw = NSFW.choose(rng).unwrap();
                mangle_fragment(nsfw, rng)
            }
        })
        .collect()
}

arr!(const NSFW: [&str; _] = [
    "0percentartificial",
    "0percentrisk",
    "1$-iphone",
    "100percentlegal",
    "100percentnatural",
    "20percentoff",
    "300deadmen",
    "419scam",
    "420",
    "500$-cashprize",
    "69",
    "7-11-robbery",
    "800-dollars-4u",
    "9-11-jumper",
    "9-11-video",
    "911-call",
    "abuse",
    "adblock-bypass",
    "admin",
    "ads",
    "advert",
    "affair",
    "al-qaeda",
    "al-qaeda-signup",
    "alien-abduction",
    "all-natural",
    "ambien",
    "anal",
    "anal-penetration",
    "analsex",
    "ancient-cure",
    "ancient-diet-pills",
    "anti-aging-pills",
    "anti-e-pills",
    "anti-estrogen-pills",
    "anti-t-pills",
    "anti-testosterone-pills",
    "antifa-kills-maga",
    "antifamurder",
    "antivirus",
    "apple-giveaway",
    "ass-beating",
    "ass2ass",
    "ass2mouth",
    "assault",
    "assfucking",
    "audio",
    "babes",
    "back-orifice",
    "backdoor",
    "bad-mixtape",
    "badonkadonk",
    "bang-women",
    "banktransfer",
    "barely-legal",
    "bargains",
    "bbw",
    "bdsm",
    "beatdown",
    "beatingwomen",
    "beheading",
    "bettingonline",
    "bigasses",
    "bigbang",
    "bigbutts",
    "bigcashprize",
    "bigcocks",
    "bigmilf",
    "bigtits",
    "bigwillie",
    "bigwomen",
    "billionaire",
    "bitcoin-2x",
    "bitcoin-billionaire",
    "bitcoin-cash-paydirt",
    "bitcoin-miner",
    "bitcoin-multiplier",
    "blackmaildox",
    "blood",
    "bloody-murder",
    "bodies",
    "bodybuilders",
    "bombing",
    "bondage",
    "boyfriendcamera",
    "boyfriendphone",
    "boyfriendtracker",
    "build-muscle",
    "bupropion",
    "butts",
    "buttsex",
    "bypass",
    "calcium",
    "cashmoney",
    "cashnow",
    "casino",
    "casino-loosest-slots",
    "cat-torture",
    "celebaddresses",
    "celebphonenumbers",
    "celebsextape",
    "chatonline",
    "chatwithbabes",
    "cheapcheapcheap",
    "cheap-guns-ammo",
    "cheapcialis",
    "cheapdrugs",
    "cheappills",
    "cheapviagra",
    "cheat-the-system",
    "christian-murder",
    "christian-murders-muslim",
    "chromium-supplement",
    "cialis",
    "classified-doxxx",
    "click",
    "click-here",
    "clickjack",
    "clone-phone",
    "clone-simcard",
    "clownpenis",
    "cobalt-supplement",
    "cocaine",
    "cockfights",
    "coinsonline",
    "coin-multiplier",
    "conspiracy",
    "cookie",
    "cookiestealer",
    "coupons",
    "cowgirl",
    "crackcocaine",
    "craigslist-blowjob",
    "craigslist-hookup",
    "creditcard",
    "creditcard-numbers",
    "crime-tips",
    "crypto",
    "cummy",
    "cures",
    "cure-anything",
    "cyberattack",
    "cyberstalk",
    "daesh",
    "daeshmeetup",
    "daeshrecruitment",
    "daeshsignup",
    "darkweb",
    "date-hot-babes",
    "date-hot-chix",
    "date-hot-guys",
    "date-hot-trans-babes",
    "date-hot-trans-chix",
    "date-hot-trans-guys",
    "dating4oldppl",
    "dead-animals",
    "dead-people",
    "deals",
    "death",
    "declassified",
    "declassified-dox",
    "deepfakes",
    "deepweb",
    "deepweb-drugs",
    "deepweb-guns",
    "diaperkink",
    "diazepam",
    "dickenlargement",
    "diet-supplement",
    "digital",
    "digitalcurrency",
    "digitalpharmacy",
    "dildoemporium",
    "doctorrecommended",
    "dogsex",
    "dogtorture",
    "dollarforex",
    "domesticabuse",
    "donate",
    "donkeycock",
    "donkeyshow",
    "dothisbytomorrow",
    "dothisnow",
    "doxxing",
    "doxxx",
    "drivebyshooting",
    "drugs",
    "dungeon",
    "earn-ur-degree-online",
    "easymen",
    "easymoney",
    "easywomen",
    "echinacea",
    "effexor",
    "electionfraud",
    "emailscam",
    "endless-health",
    "endless-money",
    "enhancement",
    "enter2win",
    "escort",
    "estradiol",
    "estrogen",
    "etherium",
    "etherium-multiplier",
    "euro-forex",
    "evidence",
    "exclusive-sextape",
    "execution",
    "fakelogin",
    "faminepics",
    "fappeningpics",
    "fast-weightloss-diet",
    "fastremedy",
    "fastweightloss",
    "fight-aging",
    "finalmoments",
    "finalsolution",
    "fingering",
    "fisting",
    "flashplayer-exploit",
    "flightpoints",
    "footageofdeath",
    "footfetish",
    "footporn",
    "forex",
    "forex-nobearmarket",
    "forexinterbank",
    "fraudalert",
    "freakout",
    "freeandroid",
    "freeinternet",
    "freeiphone",
    "freemeds",
    "freephone",
    "freepills",
    "freeporn",
    "freeshows",
    "freetv",
    "freevirusremoval",
    "freewebcams",
    "french",
    "frottage",
    "fucktonight",
    "gangbang",
    "gaysex",
    "german",
    "german-scat-porn",
    "getagirl",
    "getjacked",
    "getlaid",
    "getlaidtonite",
    "getrichovernight",
    "getrichquick",
    "getting-fucked",
    "girlcock",
    "girldick",
    "girlfriendcamera",
    "girlfriendphone",
    "girlfriendtracker",
    "giveaway",
    "gonesexual",
    "gonewild",
    "gonewrong",
    "gorepix",
    "governmentdocuments",
    "governmentdox",
    "gpstracking",
    "graphicimages",
    "grindrhookup",
    "gunfightfootage",
    "gunsonline",
    "hacking-a-facebook",
    "hateminorities",
    "headshot",
    "he-dies",
    "hefuxher",
    "helicoptercrash",
    "herbalremedy",
    "heroin",
    "hijacker",
    "hitler",
    "hitler-sexfilm",
    "holisticmedicine",
    "homeless-man-murder",
    "homeless-woman-murder",
    "homelessdeath",
    "homeopathic",
    "hood-shooting",
    "horny-goat-weed",
    "horny-teens",
    "horny-women",
    "horse-sex",
    "hotbabes",
    "hotgoats",
    "hotwomen",
    "hotmail",
    "how2win",
    "how2winatcasino",
    "hugecashprize",
    "hugecocks",
    "hypnosis",
    "i-was-probed",
    "ied-footage",
    "illegal",
    "illegal-drugs",
    "illegal-guns-4-sale",
    "illegal-porno",
    "iloveu",
    "imake2000aweekathome",
    "impersonateanyone",
    "incestporn",
    "incest-daughter-father",
    "incest-daughter-mother",
    "incest-mother-son",
    "incest-father-son",
    "increase-ur-e",
    "increase-ur-t",
    "install",
    "interview",
    "intifada",
    "ip-finder",
    "ip-hijacker",
    "ip-stealer",
    "iron",
    "isis",
    "isisrecruiter",
    "isistrainingcamp",
    "islam-murder",
    "israel",
    "iwasabductedbyaliens",
    "jackedoff",
    "jacking",
    "jackingit",
    "jackingoff",
    "jackpot",
    "jackpot-lottry-winner",
    "jailbait",
    "jailbeatdown",
    "jailbreak",
    "jailhouse-beatdown",
    "jailhouse-murder",
    "jailhouse-stabbing",
    "jailmurder",
    "jailstabbing",
    "japanese",
    "japanese-tentacle-porn",
    "jar-inserted",
    "jar-jar-porn",
    "javascript-exploit",
    "jelqing",
    "jew-nwo",
    "jewish-conspiracy",
    "jewishbanks",
    "jihad",
    "jihadinusa",
    "jizz",
    "jizz-fountain",
    "join-an-orgy",
    "join-now",
    "join-our-cult",
    "join-us",
    "joinisis",
    "journalist",
    "k9porn",
    "keygen",
    "keylog",
    "keylogger",
    "kill",
    "killallimmigrants",
    "killgays",
    "killing",
    "killwomen",
    "kingscandal",
    "kinkyporno",
    "knifefight",
    "krackapassword",
    "krazy-deals",
    "krazy-good-deal",
    "leaked-documents",
    "leaked-dox",
    "legalbabes",
    "legend-tits",
    "legendary-growth",
    "legendjackpot",
    "lemonparty",
    "lesbiansfuck",
    "levitra",
    "lexapro",
    "localmen",
    "localwomen",
    "loli-pics",
    "lolicon-pics",
    "lonelywomen",
    "looseslots",
    "loosesluts",
    "lorazepam",
    "lotto-winner",
    "lsdcheap",
    "m4m",
    "m4t",
    "m4w",
    "magic-cure",
    "magicmoney",
    "magicmushrooms",
    "magicweightloss",
    "makehercum",
    "makemoneyathome",
    "makemoneydoingnothing",
    "makemoneyfast",
    "maleenhancement",
    "malwareinstaller",
    "manybabes",
    "marijuana",
    "matureporn",
    "mdmaonline",
    "medical-magic-mushrooms",
    "medical-mmj",
    "medicalmushrooms",
    "meds4cheap",
    "medsfromcanada",
    "medsfromchina",
    "medsfromeurope",
    "medsfromvanuatu",
    "megajackpot",
    "megatits",
    "mein-kampf",
    "mercenary",
    "mercenary-kills-kids",
    "microsoft-giveaway",
    "mike-pence-gay",
    "mike-pence-naked",
    "milf",
    "milf-tits",
    "millionaire",
    "mine-coins-for-free",
    "mom-daughter-fuck",
    "mom-has-sex-with-son",
    "mommy-milkers",
    "monster-erection",
    "morecash",
    "moreincome",
    "moremoney",
    "morewins",
    "msm-supplement",
    "multivitamin",
    "mushrooms",
    "muslim",
    "muslim-murders-christian",
    "my-tits-are-legend",
    "nakedcelebs",
    "nazi",
    "nazi-beatdown",
    "newcure",
    "newdrugs",
    "newincome",
    "newremedy",
    "newworldorder",
    "nftscam",
    "nigeria-bank-transfer",
    "no-risk",
    "nsfw",
    "nudes",
    "nwo",
    "old-ladies",
    "oldmangangbang",
    "oldmen",
    "oldremedy",
    "online-horse-race",
    "onlinebetting",
    "onlinepharma",
    "onlinepharmacy",
    "only10dollars",
    "orangutansex",
    "organ",
    "organ-selling",
    "overnight",
    "overnightcure",
    "overnightgrowth",
    "overnightwealth",
    "overnightweightloss",
    "overnitebillionaire",
    "overnitemillionaire",
    "overnitesuccess",
    "overnitetrillionaire",
    "passwordhack",
    "penetration",
    "penisenlargement",
    "petitmilf",
    "pewdiepie-sextape",
    "pharmacanada",
    "pharmachina",
    "pharmacy",
    "pharmaeuro",
    "pharmavanuatu",
    "phishing",
    "phonenumbers",
    "phosphorous-supplements",
    "physical-removal",
    "pickup",
    "pickup-girls",
    "pigsex",
    "pills",
    "pills4cheap",
    "pimping-guide",
    "pipebomb",
    "piratedmovies",
    "piratedmusic",
    "piratedpodcasts",
    "piratedshows",
    "pizzagate",
    "pokeronline",
    "pokerrealmoney",
    "policebodycam",
    "poopsex",
    "popunder",
    "popup",
    "porn",
    "prince",
    "prince-scandal",
    "princess",
    "princess-scandal",
    "probing",
    "protein",
    "proteinpowder",
    "prozac",
    "psilocybin",
    "psilocybin-online",
    "public",
    "publicsex",
    "pussyfuck",
    "putin-naked",
    "putinsdick",
    "qanonreveal",
    "queen-nudes",
    "queenscandal",
    "quickie",
    "quicklygetrich",
    "quiturjob",
    "racism-website",
    "racist",
    "racket",
    "rapid-growth",
    "rapid-weightloss",
    "ratsex",
    "realcatsex",
    "realdeath",
    "realdogsex",
    "realdonkeyshow",
    "reallyhornygirls",
    "removevirus",
    "richfast",
    "richovernight",
    "richquick",
    "rickroll",
    "ripoff",
    "rippedfast",
    "risperidol",
    "rootkit",
    "ropebondage",
    "ropeporn",
    "russian-bots",
    "russian-brides",
    "scat-porn",
    "school-shooting",
    "scissoring",
    "secretcams",
    "secret-plans",
    "secretary",
    "see-me-naked",
    "seeherwebcam",
    "seemypussy",
    "seemytits",
    "sell-your-organs",
    "seroquel",
    "sexsexsex",
    "sexoffender",
    "sextape",
    "sexting",
    "sextwithgrannies",
    "sextwithgrandpas",
    "sexwithcats",
    "sexwithdogs",
    "sexwithgerbils",
    "sexyladies",
    "sexywomen",
    "shartporn",
    "she-will-never-know",
    "shedies",
    "shefuxhim",
    "shemale",
    "shes-barely-legal",
    "sheswaiting4u",
    "shiteating",
    "shitfountain",
    "shitfucking",
    "shocking",
    "shocksite",
    "shootingpix",
    "shoplifting",
    "shotapics",
    "shotacon-pics",
    "sim-clone",
    "skinned-alive",
    "skinned-cats",
    "slutcams",
    "sluts",
    "smallcocks",
    "snuff-films",
    "social-security",
    "sourcecode-leak",
    "spam4u",
    "spyware",
    "spyonurboyfriend",
    "spyonurgirlfriend",
    "spyonurhusband",
    "spyonurwife",
    "spyware",
    "stalkher",
    "steal",
    "stjohnswort",
    "stoned-for-adultery",
    "stoning-video",
    "subwaydeath",
    "supplements",
    "supplementscheap",
    "suppository",
    "sweepstakes",
    "swissbankaccount",
    "swisslottowinner",
    "swissporn",
    "t4m",
    "t4t",
    "t4w",
    "taliban-interview",
    "taliban-meetup",
    "taliban-recruiter",
    "teen",
    "teen-barely-legal",
    "telegram-adult-rooms",
    "terrorist",
    "testosterone",
    "testosterone-supplement",
    "the-truth-about-jews",
    "thetruth",
    "they-hurt-her",
    "theycantstopyou",
    "theyhatethis",
    "threesomes",
    "threesomes-near-u",
    "tighten-my-pussy",
    "tokens",
    "toohot4tv",
    "toosexy",
    "toosexy4youtube",
    "torrent-anything",
    "trackmyex",
    "trackmywife",
    "trans-agenda",
    "trans-doctor",
    "trans-porn",
    "trillionaire",
    "trojaninstaller",
    "turkey-porn",
    "twitter-blowjob",
    "un-nwo-conspiracy",
    "underground-death",
    "unlocker4anything",
    "ur-hubby-is-cumming",
    "ur-jackpot-awaits",
    "ur-wife-is-cumming",
    "vaginapix",
    "vaginal-rejeuvenation",
    "vanadium-supplement",
    "viagra",
    "virusinstaller",
    "vitamin-b12",
    "vitamin-b6",
    "vitamin-c",
    "vitamin-d",
    "vitamin-e",
    "vitamins",
    "vpnhacker",
    "vulnexploit",
    "w4m",
    "w4t",
    "w4w",
    "warcrimes",
    "warezinstall",
    "warphotos",
    "watch",
    "watch-her-die",
    "watch-her-get-fukd",
    "watch-her-webcam",
    "watch-him-die",
    "watchmovies4free",
    "watchtv4free",
    "web-toolbar",
    "weed",
    "weightloss",
    "wetfartporn",
    "wetpussy",
    "wfh",
    "what-hes-doing",
    "what-shes-doing",
    "whattheydontwantu2know",
    "whitepower",
    "whos-my-husband-txting",
    "whos-my-wife-txting",
    "wifepussy",
    "winatblackjack",
    "winatpoker",
    "winbig",
    "windows",
    "winning",
    "winning-lotto-numbers",
    "woman-gets-stoned",
    "womanbeaten",
    "workathome",
    "worldstar",
    "worldstarfight",
    "xtc-cheap",
    "xxx-porn",
    "xxx-pussy",
    "xxx-tits",
    "xxxtra",
    "yenforex",
    "you-won",
    "youre-a-winner",
    "yourip",
    "yourssn",
    "youtube-download",
    "zinc-supplement",
    "zoo",
    "zooporn",
]);

arr!(const EXT: [&str; _] = [
    ".avi", ".bas", ".csv", ".divx", ".dll", ".doc", ".docx", ".flv", ".gif", ".htm", ".html",
    ".ini", ".jar", ".js", ".jpeg", ".jpg", ".m1v", ".m4a", ".mid", ".midi", ".mkv", ".mod", ".mov",
    ".movie", ".mpa", ".mpe", ".mpeg", ".mpg", ".mp3", ".mp4", ".p7r", ".pdf", ".png", ".ppt",
    ".pptx", ".rar", ".sgml", ".snd", ".swf", ".tiff", ".txt", ".webm", ".webp", ".vbs", ".xaf",
    ".xhtml", ".xls", ".xlsx", ".xml", ".zip",
]);

arr!(const EXT_EXE: [&str; _] = [
    ".app", ".bat", ".exe", ".msi", ".run", ".script",
]);
